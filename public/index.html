<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoLamp Dashboard</title>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #4fc3dc;
            --border: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 1.5rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Current State Card */
        .current-state {
            grid-row: span 2;
            text-align: center;
        }

        .lamp-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 1rem auto;
            background: #50C878;
            box-shadow: 0 0 60px rgba(80, 200, 120, 0.5);
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lamp-emoji {
            font-size: 4rem;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.3));
        }

        .emotion-label {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem;
        }

        .color-hex {
            font-family: monospace;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .state-details {
            margin-top: 1.5rem;
            text-align: left;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 1rem;
        }

        .state-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .state-row:last-child {
            border-bottom: none;
        }

        .state-label {
            color: var(--text-secondary);
        }

        .state-value {
            font-weight: 500;
        }

        /* Timeline Card */
        .timeline-card {
            grid-column: 2;
        }

        .timeline-container {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 1rem 0;
        }

        .timeline-hour {
            flex: 1;
            min-width: 40px;
            text-align: center;
        }

        .timeline-bar {
            height: 60px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .timeline-bar.active {
            background: var(--accent);
        }

        .timeline-bar.has-data {
            box-shadow: 0 0 10px rgba(79, 195, 220, 0.3);
        }

        .timeline-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Distribution Card */
        .distribution-card {
            grid-column: 2;
        }

        .chart-container {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .donut-chart {
            position: relative;
            width: 180px;
            height: 180px;
            flex-shrink: 0;
        }

        .donut-chart svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .donut-segment {
            fill: none;
            stroke-width: 30;
            transition: all 0.5s ease;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-total {
            font-size: 2rem;
            font-weight: 700;
        }

        .donut-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-text {
            flex: 1;
        }

        .legend-emotion {
            font-size: 0.875rem;
        }

        .legend-percent {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Recent Logs Card */
        .recent-card {
            grid-column: 1;
        }

        .log-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: rgba(0,0,0,0.2);
            transition: background 0.2s;
        }

        .log-item:hover {
            background: rgba(0,0,0,0.3);
        }

        .log-emoji {
            font-size: 1.5rem;
        }

        .log-color {
            width: 8px;
            height: 40px;
            border-radius: 4px;
        }

        .log-content {
            flex: 1;
        }

        .log-emotion {
            font-weight: 500;
        }

        .log-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Summary Card */
        .summary-card {
            grid-column: 2;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }

            .current-state {
                grid-row: auto;
            }

            .timeline-card,
            .distribution-card,
            .summary-card {
                grid-column: 1;
            }

            .chart-container {
                flex-direction: column;
            }

            .donut-chart {
                width: 150px;
                height: 150px;
            }
        }

        @media (max-width: 500px) {
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .container {
                padding: 1rem;
                gap: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .lamp-preview {
                width: 120px;
                height: 120px;
            }

            .lamp-emoji {
                font-size: 3rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üåà EmoLamp Dashboard</h1>
        <div class="status-badge">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Ïó∞Í≤∞Îê®</span>
        </div>
    </header>

    <main class="container">
        <!-- ÌòÑÏû¨ ÏÉÅÌÉú -->
        <section class="card current-state">
            <div class="card-title">ÌòÑÏû¨ ÏÉÅÌÉú</div>
            <div class="lamp-preview" id="lampPreview">
                <span class="lamp-emoji" id="currentEmoji">üòå</span>
            </div>
            <div class="emotion-label" id="currentEmotion">ÌèâÏò®</div>
            <div class="color-hex" id="currentHex">#50C878</div>
            
            <div class="state-details">
                <div class="state-row">
                    <span class="state-label">Î™®Îìú</span>
                    <span class="state-value" id="currentMode">AUTO</span>
                </div>
                <div class="state-row">
                    <span class="state-label">Hue</span>
                    <span class="state-value" id="currentHue">120¬∞</span>
                </div>
                <div class="state-row">
                    <span class="state-label">Ï±ÑÎèÑ</span>
                    <span class="state-value" id="currentSat">70%</span>
                </div>
                <div class="state-row">
                    <span class="state-label">Î™ÖÎèÑ</span>
                    <span class="state-value" id="currentBright">70%</span>
                </div>
                <div class="state-row">
                    <span class="state-label">ÎÇ†Ïî®</span>
                    <span class="state-value" id="currentWeather">-</span>
                </div>
            </div>
        </section>

        <!-- ÌÉÄÏûÑÎùºÏù∏ -->
        <section class="card timeline-card">
            <div class="card-title">Ïò§ÎäòÏùò Í∞êÏ†ï ÌÉÄÏûÑÎùºÏù∏</div>
            <div class="timeline-container" id="timeline">
                <!-- JSÎ°ú ÏÉùÏÑ± -->
            </div>
        </section>

        <!-- Í∞êÏ†ï Î∂ÑÌè¨ -->
        <section class="card distribution-card">
            <div class="card-title">Í∞êÏ†ï Î∂ÑÌè¨</div>
            <div class="chart-container">
                <div class="donut-chart">
                    <svg viewBox="0 0 100 100" id="donutChart">
                        <!-- JSÎ°ú ÏÉùÏÑ± -->
                    </svg>
                    <div class="donut-center">
                        <div class="donut-total" id="totalCount">0</div>
                        <div class="donut-label">Ï¥ù Î∂ÑÏÑù</div>
                    </div>
                </div>
                <div class="legend" id="legend">
                    <!-- JSÎ°ú ÏÉùÏÑ± -->
                </div>
            </div>
        </section>

        <!-- ÏµúÍ∑º Í∏∞Î°ù -->
        <section class="card recent-card">
            <div class="card-title">ÏµúÍ∑º Í∏∞Î°ù</div>
            <div class="log-list" id="recentLogs">
                <!-- JSÎ°ú ÏÉùÏÑ± -->
            </div>
        </section>

        <!-- ÎàÑÏ†Å ÌÜµÍ≥Ñ -->
        <section class="card summary-card">
            <div class="card-title">ÎàÑÏ†Å ÌÜµÍ≥Ñ</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="summaryTotal">0</div>
                    <div class="summary-label">Ï¥ù Î∂ÑÏÑù ÌöüÏàò</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="summaryToday">0</div>
                    <div class="summary-label">Ïò§Îäò Î∂ÑÏÑù</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="summaryTopEmotion">üòå</div>
                    <div class="summary-label">ÏµúÎã§ Í∞êÏ†ï</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="summaryAvgHue">120¬∞</div>
                    <div class="summary-label">ÌèâÍ∑† Hue</div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Í∞êÏ†ïÎ≥Ñ ÏÉâÏÉÅ
        const emotionColors = {
            joy: '#FFD700',
            sadness: '#4169E1',
            anger: '#DC143C',
            calm: '#50C878',
            excited: '#FF8C00',
            fear: '#9932CC',
            surprise: '#FFFF00'
        };

        // API Í∏∞Î≥∏ URL
        const API_BASE = '';

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let currentData = {};
        let timelineData = [];
        let distributionData = [];
        let recentData = [];

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            initTimeline();
            fetchAllData();
            // 5Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
            setInterval(fetchAllData, 5000);
        });

        // ÌÉÄÏûÑÎùºÏù∏ Ï¥àÍ∏∞Ìôî
        function initTimeline() {
            const container = document.getElementById('timeline');
            container.innerHTML = '';
            
            for (let i = 0; i < 24; i++) {
                const hour = document.createElement('div');
                hour.className = 'timeline-hour';
                hour.innerHTML = `
                    <div class="timeline-bar" id="hour-${i}"></div>
                    <div class="timeline-label">${i.toString().padStart(2, '0')}</div>
                `;
                container.appendChild(hour);
            }
        }

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function fetchAllData() {
            try {
                await Promise.all([
                    fetchCurrent(),
                    fetchTimeline(),
                    fetchDistribution(),
                    fetchRecent(),
                    fetchSummary()
                ]);
                updateStatus(true);
            } catch (error) {
                console.error('Fetch error:', error);
                updateStatus(false);
            }
        }

        // ÌòÑÏû¨ ÏÉÅÌÉú
        async function fetchCurrent() {
            const res = await fetch(`${API_BASE}/api/stats/current`);
            const data = await res.json();
            currentData = data;
            updateCurrentUI(data);
        }

        // ÌÉÄÏûÑÎùºÏù∏
        async function fetchTimeline() {
            const res = await fetch(`${API_BASE}/api/stats/timeline`);
            const data = await res.json();
            timelineData = data.timeline;
            updateTimelineUI(data.timeline);
        }

        // Í∞êÏ†ï Î∂ÑÌè¨
        async function fetchDistribution() {
            const res = await fetch(`${API_BASE}/api/stats/emotions`);
            const data = await res.json();
            distributionData = data;
            updateDistributionUI(data);
        }

        // ÏµúÍ∑º Í∏∞Î°ù
        async function fetchRecent() {
            const res = await fetch(`${API_BASE}/api/stats/recent?limit=20`);
            const data = await res.json();
            recentData = data.logs;
            updateRecentUI(data.logs);
        }

        // ÏöîÏïΩ ÌÜµÍ≥Ñ
        async function fetchSummary() {
            const res = await fetch(`${API_BASE}/api/stats/summary`);
            const data = await res.json();
            updateSummaryUI(data);
        }

        // UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§
        function updateCurrentUI(data) {
            const lamp = document.getElementById('lampPreview');
            const color = data.colorHex || '#50C878';
            lamp.style.background = color;
            lamp.style.boxShadow = `0 0 60px ${color}80`;

            document.getElementById('currentEmoji').textContent = data.emotionEmoji || 'üòå';
            document.getElementById('currentEmotion').textContent = data.emotionKorean || 'ÌèâÏò®';
            document.getElementById('currentHex').textContent = color;
            document.getElementById('currentMode').textContent = data.mode || 'AUTO';
            document.getElementById('currentHue').textContent = `${data.hue || 120}¬∞`;
            document.getElementById('currentSat').textContent = `${data.saturation || 70}%`;
            document.getElementById('currentBright').textContent = `${data.brightness || 70}%`;
            
            const weather = data.weather 
                ? `${data.weatherEmoji || ''} ${data.temperature || '-'}¬∞C`
                : '-';
            document.getElementById('currentWeather').textContent = weather;
        }

        function updateTimelineUI(timeline) {
            const now = new Date().getHours();
            
            timeline.forEach(item => {
                const bar = document.getElementById(`hour-${item.hour}`);
                if (!bar) return;
                
                bar.classList.remove('active', 'has-data');
                bar.style.background = '';
                bar.textContent = '';
                
                if (item.hour === now) {
                    bar.classList.add('active');
                }
                
                if (item.emotion && item.count > 0) {
                    bar.classList.add('has-data');
                    bar.style.background = item.colorHex || emotionColors[item.emotion];
                    bar.textContent = item.emoji;
                }
            });
        }

        function updateDistributionUI(data) {
            const svg = document.getElementById('donutChart');
            const legend = document.getElementById('legend');
            
            document.getElementById('totalCount').textContent = data.total;
            
            // ÎèÑÎÑõ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            svg.innerHTML = '';
            let offset = 0;
            const radius = 35;
            const circumference = 2 * Math.PI * radius;
            
            if (data.distribution.length === 0) {
                // Îç∞Ïù¥ÌÑ∞ ÏóÜÏùÑ Îïå
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '50');
                circle.setAttribute('cy', '50');
                circle.setAttribute('r', radius);
                circle.setAttribute('class', 'donut-segment');
                circle.setAttribute('stroke', '#333');
                circle.setAttribute('stroke-dasharray', `${circumference} ${circumference}`);
                svg.appendChild(circle);
            } else {
                data.distribution.forEach(item => {
                    const segmentLength = (item.percentage / 100) * circumference;
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '50');
                    circle.setAttribute('cy', '50');
                    circle.setAttribute('r', radius);
                    circle.setAttribute('class', 'donut-segment');
                    circle.setAttribute('stroke', emotionColors[item.emotion] || '#666');
                    circle.setAttribute('stroke-dasharray', `${segmentLength} ${circumference - segmentLength}`);
                    circle.setAttribute('stroke-dashoffset', -offset);
                    svg.appendChild(circle);
                    offset += segmentLength;
                });
            }
            
            // Î≤îÎ°Ä
            legend.innerHTML = data.distribution.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${emotionColors[item.emotion] || '#666'}"></div>
                    <div class="legend-text">
                        <div class="legend-emotion">${item.emoji} ${item.korean}</div>
                        <div class="legend-percent">${item.percentage}% (${item.count})</div>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentUI(logs) {
            const container = document.getElementById('recentLogs');
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:2rem;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="log-item">
                    <div class="log-color" style="background: ${log.colorHex || '#50C878'}"></div>
                    <div class="log-emoji">${log.emoji}</div>
                    <div class="log-content">
                        <div class="log-emotion">${log.emotionKorean}</div>
                        <div class="log-time">${formatTime(log.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateSummaryUI(data) {
            document.getElementById('summaryTotal').textContent = data.totalAnalyses;
            document.getElementById('summaryToday').textContent = data.todayAnalyses;
            document.getElementById('summaryTopEmotion').textContent = 
                `${data.topEmotionEmoji} ${data.topEmotionKorean}`;
            document.getElementById('summaryAvgHue').textContent = `${data.averageHue}¬∞`;
        }

        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.style.background = '#4caf50';
                text.textContent = 'Ïó∞Í≤∞Îê®';
            } else {
                dot.style.background = '#f44336';
                text.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Î∞©Í∏à Ï†Ñ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}Î∂Ñ Ï†Ñ`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}ÏãúÍ∞Ñ Ï†Ñ`;
            
            return date.toLocaleString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>